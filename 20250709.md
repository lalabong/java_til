
# Flyway

## 개요

**Flyway**는 데이터베이스 스키마 변경사항을 버전 관리하고 자동화된 데이터베이스 배포를 안전하고 쉽게 수행할 수 있도록 도와주는 오픈소스 데이터베이스 마이그레이션 도구입니다. 간단히 말해서 **데이터베이스용 Git**으로, 데이터베이스의 DDL 이력을 쌓아서 관리하는 툴입니다.

## 핵심 기능

### 버전 관리 시스템

- **버전 기반 마이그레이션**: 각 데이터베이스 변경사항을 버전 번호가 있는 마이그레이션 스크립트로 관리
- **스키마 히스토리 테이블**: `flyway_schema_history` 테이블을 통해 데이터베이스 변경 이력을 추적
- **체크섬 검증**: 마이그레이션 스크립트의 무결성을 자동으로 검증


### 다양한 스크립트 지원

- **SQL 마이그레이션**: 평범한 SQL 문법 사용 가능
- **Java 마이그레이션**: Java 코드로도 마이그레이션 작성 가능
- **데이터베이스별 문법**: PL/SQL, T-SQL 등 데이터베이스 특화 문법 지원


### 자동화 및 통합

- **CI/CD 파이프라인 통합**: 지속적 통합/배포 환경에서 자동화된 데이터베이스 배포
- **애플리케이션 시작 시 자동 실행**: 애플리케이션 구동 시 자동으로 마이그레이션 적용
- **다양한 데이터베이스 지원**: MySQL, PostgreSQL, Oracle, SQL Server 등 30개 이상의 데이터베이스 지원


## 동작 원리

### 1. 초기 설정

1. **빈 데이터베이스**에 Flyway를 적용하면 스키마 히스토리 테이블을 생성
2. 기본적으로 `flyway_schema_history` 테이블이 생성되어 데이터베이스 상태를 추적

### 2. 마이그레이션 스캔

- 파일시스템 또는 클래스패스에서 마이그레이션 스크립트를 스캔
- 버전 번호에 따라 마이그레이션을 정렬하고 순서대로 적용


### 3. 마이그레이션 적용

- 각 마이그레이션은 단일 데이터베이스 트랜잭션 내에서 실행
- 적용된 마이그레이션은 스키마 히스토리 테이블에 기록


## 주요 장점

### 개발 효율성

- **소스코드 상에서 관리**: 데이터베이스 변경사항을 코드와 함께 버전 관리
- **환경 간 일관성**: 개발, 테스트, 운영 환경 간 데이터베이스 스키마 일관성 보장
- **자동화된 배포**: 수동 작업을 줄이고 배포 프로세스 자동화


### 안정성 및 신뢰성

- **변경 추적**: 모든 데이터베이스 변경사항을 추적하고 문서화
- **자동 백업**: 변경 적용 전 자동으로 데이터베이스 백업 생성
- **위험 완화**: 데이터 손실 위험을 줄이고 안전한 마이그레이션 제공


### 협업 지원

- **팀 협업**: 개발자 간 데이터베이스 변경사항 공유 및 협업 지원
- **변경 리뷰**: 마이그레이션 스크립트 리뷰 및 롤백 가능


## 파일 명명 규칙

### 버전 기반 마이그레이션

```
V + 버전번호 + __ + 설명.sql
```

**예시:**

- `V1__create_user_table.sql`
- `V2__add_email_column.sql`
- `V3__create_index_on_email.sql`


### 파일 위치

- 기본 경로: `src/main/resources/db/migration/`
- 커스텀 경로 설정 가능


## 설정 방법

### Gradle 의존성

```gradle
dependencies {
    implementation 'org.flywaydb:flyway-core'
    implementation 'org.flywaydb:flyway-mysql' // MySQL 사용 시
}
```


### Spring Boot 설정 (application.yml)

```yaml
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    baseline-version: 1
```


## 주요 사용 사례

### 1. 복잡한 애플리케이션의 스키마 관리

- 빈번한 데이터베이스 스키마 변경이 있는 복잡한 애플리케이션에서 통제된 진화 보장


### 2. 다중 환경 관리

- 개발, 테스트, 운영 환경 간 데이터베이스 스키마 일관성 유지


### 3. CI/CD 파이프라인 통합

- 코드 배포와 함께 데이터베이스 스키마 변경사항 자동 배포


### 4. 레거시 시스템 현대화

- 기존 시스템을 점진적으로 업데이트할 때 구조화된 접근 방식 제공


## 제한사항 및 주의사항


### 스크립트 변경 제한

- **성공한 SQL 파일 변경 금지**: 해시 값이 변경되어 이후 마이그레이션에 문제 발생 가능
- **새로운 버전으로 변경사항 적용**: 기존 스크립트 수정 대신 새로운 마이그레이션 스크립트 작성 권장

## 모범 사례

### 1. 마이그레이션 스크립트 작성

- **멱등성 보장**: 동일한 마이그레이션을 여러 번 실행해도 안전하도록 작성
- **트랜잭션 고려**: 각 마이그레이션이 단일 트랜잭션에서 실행됨을 고려
- **테스트**: 마이그레이션 스크립트를 프로덕션 적용 전 충분히 테스트


### 2. 버전 관리

- **순차적 버전 번호**: 명확한 순서로 버전 번호 부여
- **의미 있는 설명**: 마이그레이션 내용을 명확히 설명하는 파일명 사용


### 3. 환경별 관리

- **환경별 설정**: 개발, 테스트, 운영 환경별로 적절한 설정 적용
- **데이터 분리**: 스키마 변경과 데이터 변경을 분리하여 관리

## 느낀 점
- flyway를 사용하다가 db가 날아가고 빌드가 실패하고 API 테스트를 못하는 등 우여곡절이 많았지만 조사 및 공부가 부족했던 탓이라고 하자. 